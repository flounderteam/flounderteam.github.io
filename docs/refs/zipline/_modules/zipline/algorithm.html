

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>zipline.algorithm &mdash; Zipline 1.4.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Zipline
          

          
          </a>

          
            
            
              <div class="version">
                1.4.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner-tutorial.html">Zipline Beginner Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bundles.html">Data Bundles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trading-calendars.html">Trading Calendars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../risk-and-perf-metrics.html">Risk and Performance Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development-guidelines.html">Development Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-process.html">Release Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Zipline</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>zipline.algorithm</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for zipline.algorithm</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright 2015 Quantopian, Inc.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">tzinfo</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">logbook</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">repeat</span>

<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">exec_</span><span class="p">,</span>
    <span class="n">iteritems</span><span class="p">,</span>
    <span class="n">itervalues</span><span class="p">,</span>
    <span class="n">string_types</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">trading_calendars.utils.pandas_utils</span> <span class="kn">import</span> <span class="n">days_at_time</span>
<span class="kn">from</span> <span class="nn">trading_calendars</span> <span class="kn">import</span> <span class="n">get_calendar</span>

<span class="kn">from</span> <span class="nn">zipline._protocol</span> <span class="kn">import</span> <span class="n">handle_non_market_minutes</span>
<span class="kn">from</span> <span class="nn">zipline.errors</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AttachPipelineAfterInitialize</span><span class="p">,</span>
    <span class="n">CannotOrderDelistedAsset</span><span class="p">,</span>
    <span class="n">DuplicatePipelineName</span><span class="p">,</span>
    <span class="n">HistoryInInitialize</span><span class="p">,</span>
    <span class="n">IncompatibleCommissionModel</span><span class="p">,</span>
    <span class="n">IncompatibleSlippageModel</span><span class="p">,</span>
    <span class="n">NoSuchPipeline</span><span class="p">,</span>
    <span class="n">OrderDuringInitialize</span><span class="p">,</span>
    <span class="n">OrderInBeforeTradingStart</span><span class="p">,</span>
    <span class="n">PipelineOutputDuringInitialize</span><span class="p">,</span>
    <span class="n">RegisterAccountControlPostInit</span><span class="p">,</span>
    <span class="n">RegisterTradingControlPostInit</span><span class="p">,</span>
    <span class="n">ScheduleFunctionInvalidCalendar</span><span class="p">,</span>
    <span class="n">SetBenchmarkOutsideInitialize</span><span class="p">,</span>
    <span class="n">SetCancelPolicyPostInit</span><span class="p">,</span>
    <span class="n">SetCommissionPostInit</span><span class="p">,</span>
    <span class="n">SetSlippagePostInit</span><span class="p">,</span>
    <span class="n">UnsupportedCancelPolicy</span><span class="p">,</span>
    <span class="n">UnsupportedDatetimeFormat</span><span class="p">,</span>
    <span class="n">UnsupportedOrderParameters</span><span class="p">,</span>
    <span class="n">ZeroCapitalError</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">zipline.finance.blotter</span> <span class="kn">import</span> <span class="n">SimulationBlotter</span>
<span class="kn">from</span> <span class="nn">zipline.finance.controls</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">LongOnly</span><span class="p">,</span>
    <span class="n">MaxOrderCount</span><span class="p">,</span>
    <span class="n">MaxOrderSize</span><span class="p">,</span>
    <span class="n">MaxPositionSize</span><span class="p">,</span>
    <span class="n">MaxLeverage</span><span class="p">,</span>
    <span class="n">MinLeverage</span><span class="p">,</span>
    <span class="n">RestrictedListOrder</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">zipline.finance.execution</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">LimitOrder</span><span class="p">,</span>
    <span class="n">MarketOrder</span><span class="p">,</span>
    <span class="n">StopLimitOrder</span><span class="p">,</span>
    <span class="n">StopOrder</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">zipline.finance.asset_restrictions</span> <span class="kn">import</span> <span class="n">Restrictions</span>
<span class="kn">from</span> <span class="nn">zipline.finance.cancel_policy</span> <span class="kn">import</span> <span class="n">NeverCancel</span><span class="p">,</span> <span class="n">CancelPolicy</span>
<span class="kn">from</span> <span class="nn">zipline.finance.asset_restrictions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NoRestrictions</span><span class="p">,</span>
    <span class="n">StaticRestrictions</span><span class="p">,</span>
    <span class="n">SecurityListRestrictions</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">zipline.assets</span> <span class="kn">import</span> <span class="n">Asset</span><span class="p">,</span> <span class="n">Equity</span><span class="p">,</span> <span class="n">Future</span>
<span class="kn">from</span> <span class="nn">zipline.gens.tradesimulation</span> <span class="kn">import</span> <span class="n">AlgorithmSimulator</span>
<span class="kn">from</span> <span class="nn">zipline.finance.metrics</span> <span class="kn">import</span> <span class="n">MetricsTracker</span><span class="p">,</span> <span class="n">load</span> <span class="k">as</span> <span class="n">load_metrics_set</span>
<span class="kn">from</span> <span class="nn">zipline.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">import</span> <span class="nn">zipline.pipeline.domain</span> <span class="k">as</span> <span class="nn">domain</span>
<span class="kn">from</span> <span class="nn">zipline.pipeline.engine</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExplodingPipelineEngine</span><span class="p">,</span>
    <span class="n">SimplePipelineEngine</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">zipline.utils.api_support</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">api_method</span><span class="p">,</span>
    <span class="n">require_initialized</span><span class="p">,</span>
    <span class="n">require_not_initialized</span><span class="p">,</span>
    <span class="n">ZiplineAPI</span><span class="p">,</span>
    <span class="n">disallowed_in_before_trading_start</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">zipline.utils.compat</span> <span class="kn">import</span> <span class="n">ExitStack</span>
<span class="kn">from</span> <span class="nn">zipline.utils.input_validation</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">coerce_string</span><span class="p">,</span>
    <span class="n">ensure_upper_case</span><span class="p">,</span>
    <span class="n">error_keywords</span><span class="p">,</span>
    <span class="n">expect_dtypes</span><span class="p">,</span>
    <span class="n">expect_types</span><span class="p">,</span>
    <span class="n">optional</span><span class="p">,</span>
    <span class="n">optionally</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">zipline.utils.numpy_utils</span> <span class="kn">import</span> <span class="n">int64_dtype</span>
<span class="kn">from</span> <span class="nn">zipline.utils.pandas_utils</span> <span class="kn">import</span> <span class="n">normalize_date</span>
<span class="kn">from</span> <span class="nn">zipline.utils.cache</span> <span class="kn">import</span> <span class="n">ExpiringCache</span>
<span class="kn">from</span> <span class="nn">zipline.utils.pandas_utils</span> <span class="kn">import</span> <span class="n">clear_dataframe_indexer_caches</span>

<span class="kn">import</span> <span class="nn">zipline.utils.events</span>
<span class="kn">from</span> <span class="nn">zipline.utils.events</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">EventManager</span><span class="p">,</span>
    <span class="n">make_eventrule</span><span class="p">,</span>
    <span class="n">date_rules</span><span class="p">,</span>
    <span class="n">time_rules</span><span class="p">,</span>
    <span class="n">calendars</span><span class="p">,</span>
    <span class="n">AfterOpen</span><span class="p">,</span>
    <span class="n">BeforeClose</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">zipline.utils.math_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">tolerant_equals</span><span class="p">,</span>
    <span class="n">round_if_near_integer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">zipline.utils.preprocess</span> <span class="kn">import</span> <span class="n">preprocess</span>
<span class="kn">from</span> <span class="nn">zipline.utils.security_list</span> <span class="kn">import</span> <span class="n">SecurityList</span>

<span class="kn">import</span> <span class="nn">zipline.protocol</span>
<span class="kn">from</span> <span class="nn">zipline.sources.requests_csv</span> <span class="kn">import</span> <span class="n">PandasRequestsCSV</span>

<span class="kn">from</span> <span class="nn">zipline.gens.sim_engine</span> <span class="kn">import</span> <span class="n">MinuteSimulationClock</span>
<span class="kn">from</span> <span class="nn">zipline.sources.benchmark_source</span> <span class="kn">import</span> <span class="n">BenchmarkSource</span>
<span class="kn">from</span> <span class="nn">zipline.zipline_warnings</span> <span class="kn">import</span> <span class="n">ZiplineDeprecationWarning</span>


<span class="n">log</span> <span class="o">=</span> <span class="n">logbook</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="s2">&quot;ZiplineLog&quot;</span><span class="p">)</span>

<span class="c1"># For creating and storing pipeline instances</span>
<span class="n">AttachedPipeline</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;AttachedPipeline&#39;</span><span class="p">,</span> <span class="s1">&#39;pipe chunks eager&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NoBenchmark</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NoBenchmark</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s1">&#39;Must specify either benchmark_sid or benchmark_returns.&#39;</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">TradingAlgorithm</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class that represents a trading strategy and parameters to execute</span>
<span class="sd">    the strategy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args, **kwargs</span>
<span class="sd">        Forwarded to ``initialize`` unless listed below.</span>
<span class="sd">    initialize : callable[context -&gt; None], optional</span>
<span class="sd">        Function that is called at the start of the simulation to</span>
<span class="sd">        setup the initial context.</span>
<span class="sd">    handle_data : callable[(context, data) -&gt; None], optional</span>
<span class="sd">        Function called on every bar. This is where most logic should be</span>
<span class="sd">        implemented.</span>
<span class="sd">    before_trading_start : callable[(context, data) -&gt; None], optional</span>
<span class="sd">        Function that is called before any bars have been processed each</span>
<span class="sd">        day.</span>
<span class="sd">    analyze : callable[(context, DataFrame) -&gt; None], optional</span>
<span class="sd">        Function that is called at the end of the backtest. This is passed</span>
<span class="sd">        the context and the performance results for the backtest.</span>
<span class="sd">    script : str, optional</span>
<span class="sd">        Algoscript that contains the definitions for the four algorithm</span>
<span class="sd">        lifecycle functions and any supporting code.</span>
<span class="sd">    namespace : dict, optional</span>
<span class="sd">        The namespace to execute the algoscript in. By default this is an</span>
<span class="sd">        empty namespace that will include only python built ins.</span>
<span class="sd">    algo_filename : str, optional</span>
<span class="sd">        The filename for the algoscript. This will be used in exception</span>
<span class="sd">        tracebacks. default: &#39;&lt;string&gt;&#39;.</span>
<span class="sd">    data_frequency : {&#39;daily&#39;, &#39;minute&#39;}, optional</span>
<span class="sd">        The duration of the bars.</span>
<span class="sd">    equities_metadata : dict or DataFrame or file-like object, optional</span>
<span class="sd">        If dict is provided, it must have the following structure:</span>
<span class="sd">        * keys are the identifiers</span>
<span class="sd">        * values are dicts containing the metadata, with the metadata</span>
<span class="sd">          field name as the key</span>
<span class="sd">        If pandas.DataFrame is provided, it must have the</span>
<span class="sd">        following structure:</span>
<span class="sd">        * column names must be the metadata fields</span>
<span class="sd">        * index must be the different asset identifiers</span>
<span class="sd">        * array contents should be the metadata value</span>
<span class="sd">        If an object with a ``read`` method is provided, ``read`` must</span>
<span class="sd">        return rows containing at least one of &#39;sid&#39; or &#39;symbol&#39; along</span>
<span class="sd">        with the other metadata fields.</span>
<span class="sd">    futures_metadata : dict or DataFrame or file-like object, optional</span>
<span class="sd">        The same layout as ``equities_metadata`` except that it is used</span>
<span class="sd">        for futures information.</span>
<span class="sd">    identifiers : list, optional</span>
<span class="sd">        Any asset identifiers that are not provided in the</span>
<span class="sd">        equities_metadata, but will be traded by this TradingAlgorithm.</span>
<span class="sd">    get_pipeline_loader : callable[BoundColumn -&gt; PipelineLoader], optional</span>
<span class="sd">        The function that maps pipeline columns to their loaders.</span>
<span class="sd">    create_event_context : callable[BarData -&gt; context manager], optional</span>
<span class="sd">        A function used to create a context mananger that wraps the</span>
<span class="sd">        execution of all events that are scheduled for a bar.</span>
<span class="sd">        This function will be passed the data for the bar and should</span>
<span class="sd">        return the actual context manager that will be entered.</span>
<span class="sd">    history_container_class : type, optional</span>
<span class="sd">        The type of history container to use. default: HistoryContainer</span>
<span class="sd">    platform : str, optional</span>
<span class="sd">        The platform the simulation is running on. This can be queried for</span>
<span class="sd">        in the simulation with ``get_environment``. This allows algorithms</span>
<span class="sd">        to conditionally execute code based on platform it is running on.</span>
<span class="sd">        default: &#39;zipline&#39;</span>
<span class="sd">    adjustment_reader : AdjustmentReader</span>
<span class="sd">        The interface to the adjustments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">sim_params</span><span class="p">,</span>
                 <span class="n">data_portal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">asset_finder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="c1"># Algorithm API</span>
                 <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">script</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">algo_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">initialize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">handle_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">before_trading_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">analyze</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="c1">#</span>
                 <span class="n">trading_calendar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">metrics_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">blotter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">blotter_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cancel_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">benchmark_sid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">benchmark_returns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;zipline&#39;</span><span class="p">,</span>
                 <span class="n">capital_changes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">get_pipeline_loader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">create_event_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">initialize_kwargs</span><span class="p">):</span>
        <span class="c1"># List of trading controls to be used to validate orders.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trading_controls</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># List of account controls to be checked on each bar.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_controls</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_recorded_vars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_platform</span> <span class="o">=</span> <span class="n">platform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># XXX: This is kind of a mess.</span>
        <span class="c1"># We support passing a data_portal in `run`, but we need an asset</span>
        <span class="c1"># finder earlier than that to look up assets for things like</span>
        <span class="c1"># set_benchmark.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span> <span class="o">=</span> <span class="n">data_portal</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">asset_finder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Must pass either data_portal or asset_finder &quot;</span>
                    <span class="s2">&quot;to TradingAlgorithm()&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span> <span class="o">=</span> <span class="n">asset_finder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Raise an error if we were passed two different asset finders.</span>
            <span class="c1"># There&#39;s no world where that&#39;s a good idea.</span>
            <span class="k">if</span> <span class="n">asset_finder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
               <span class="ow">and</span> <span class="n">asset_finder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">data_portal</span><span class="o">.</span><span class="n">asset_finder</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Inconsistent asset_finders in TradingAlgorithm()&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span> <span class="o">=</span> <span class="n">data_portal</span><span class="o">.</span><span class="n">asset_finder</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_returns</span> <span class="o">=</span> <span class="n">benchmark_returns</span>

        <span class="c1"># XXX: This is also a mess. We should remove all of this and only allow</span>
        <span class="c1">#      one way to pass a calendar.</span>
        <span class="c1">#</span>
        <span class="c1"># We have a required sim_params argument as well as an optional</span>
        <span class="c1"># trading_calendar argument, but sim_params has a trading_calendar</span>
        <span class="c1"># attribute. If the user passed trading_calendar explicitly, make sure</span>
        <span class="c1"># it matches their sim_params. Otherwise, just use what&#39;s in their</span>
        <span class="c1"># sim_params.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span> <span class="o">=</span> <span class="n">sim_params</span>
        <span class="k">if</span> <span class="n">trading_calendar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span> <span class="o">=</span> <span class="n">sim_params</span><span class="o">.</span><span class="n">trading_calendar</span>
        <span class="k">elif</span> <span class="n">trading_calendar</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">sim_params</span><span class="o">.</span><span class="n">trading_calendar</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span> <span class="o">=</span> <span class="n">sim_params</span><span class="o">.</span><span class="n">trading_calendar</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Conflicting calendars: trading_calendar=</span><span class="si">{}</span><span class="s2">, but &quot;</span>
                <span class="s2">&quot;sim_params.trading_calendar=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">trading_calendar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">trading_calendar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_tracker</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_sync_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics_set</span> <span class="o">=</span> <span class="n">metrics_set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metrics_set</span> <span class="o">=</span> <span class="n">load_metrics_set</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

        <span class="c1"># Initialize Pipeline API data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_engine</span><span class="p">(</span><span class="n">get_pipeline_loader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipelines</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Create an already-expired cache so that we compute the first time</span>
        <span class="c1"># data is requested.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_cache</span> <span class="o">=</span> <span class="n">ExpiringCache</span><span class="p">(</span>
            <span class="n">cleanup</span><span class="o">=</span><span class="n">clear_dataframe_indexer_caches</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">blotter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span> <span class="o">=</span> <span class="n">blotter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cancel_policy</span> <span class="o">=</span> <span class="n">cancel_policy</span> <span class="ow">or</span> <span class="n">NeverCancel</span><span class="p">()</span>
            <span class="n">blotter_class</span> <span class="o">=</span> <span class="n">blotter_class</span> <span class="ow">or</span> <span class="n">SimulationBlotter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span> <span class="o">=</span> <span class="n">blotter_class</span><span class="p">(</span><span class="n">cancel_policy</span><span class="o">=</span><span class="n">cancel_policy</span><span class="p">)</span>

        <span class="c1"># The symbol lookup date specifies the date to use when resolving</span>
        <span class="c1"># symbols to sids, and can be set using set_symbol_lookup_date()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_symbol_lookup_date</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># If string is passed in, execute and get reference to</span>
        <span class="c1"># functions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algoscript</span> <span class="o">=</span> <span class="n">script</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_before_trading_start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyze</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_in_before_trading_start</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">event_manager</span> <span class="o">=</span> <span class="n">EventManager</span><span class="p">(</span><span class="n">create_event_context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">noop</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algoscript</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unexpected_api_methods</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">initialize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">unexpected_api_methods</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;initialize&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handle_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">unexpected_api_methods</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;handle_data&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">before_trading_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">unexpected_api_methods</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;before_trading_start&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">analyze</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">unexpected_api_methods</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;analyze&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">unexpected_api_methods</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;TradingAlgorithm received a script and the following API&quot;</span>
                    <span class="s2">&quot; methods as functions:</span><span class="se">\n</span><span class="si">{funcs}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">funcs</span><span class="o">=</span><span class="n">unexpected_api_methods</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">algo_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">algo_filename</span> <span class="o">=</span> <span class="s1">&#39;&lt;string&gt;&#39;</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algoscript</span><span class="p">,</span> <span class="n">algo_filename</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
            <span class="n">exec_</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initialize&#39;</span><span class="p">,</span> <span class="n">noop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;handle_data&#39;</span><span class="p">,</span> <span class="n">noop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_before_trading_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;before_trading_start&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Optional analyze function, gets called after run</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analyze</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;analyze&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span> <span class="o">=</span> <span class="n">initialize</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_data</span> <span class="o">=</span> <span class="n">handle_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_before_trading_start</span> <span class="o">=</span> <span class="n">before_trading_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analyze</span> <span class="o">=</span> <span class="n">analyze</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">event_manager</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span>
            <span class="n">zipline</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span>
                <span class="n">zipline</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">Always</span><span class="p">(),</span>
                <span class="c1"># We pass handle_data.__func__ to get the unbound method.</span>
                <span class="c1"># We will explicitly pass the algorithm to bind it again.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_data</span><span class="o">.</span><span class="vm">__func__</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">prepend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">capital_base</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ZeroCapitalError</span><span class="p">()</span>

        <span class="c1"># Prepare the algo for initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_kwargs</span> <span class="o">=</span> <span class="n">initialize_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_sid</span> <span class="o">=</span> <span class="n">benchmark_sid</span>

        <span class="c1"># A dictionary of capital changes, keyed by timestamp, indicating the</span>
        <span class="c1"># target/delta of the capital changes, along with values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital_changes</span> <span class="o">=</span> <span class="n">capital_changes</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># A dictionary of the actual capital change deltas, keyed by timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital_change_deltas</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">restrictions</span> <span class="o">=</span> <span class="n">NoRestrictions</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_backwards_compat_universe</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">init_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_loader</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct and store a PipelineEngine from loader.</span>

<span class="sd">        If get_loader is None, constructs an ExplodingPipelineEngine</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">get_loader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">SimplePipelineEngine</span><span class="p">(</span>
                <span class="n">get_loader</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_pipeline_domain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">ExplodingPipelineEngine</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call self._initialize with `self` made available to Zipline API</span>
<span class="sd">        functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ZiplineAPI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_trading_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_eager_pipelines</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_trading_start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_in_before_trading_start</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">with</span> <span class="n">handle_non_market_minutes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">data_frequency</span> <span class="o">==</span> <span class="s2">&quot;minute&quot;</span> <span class="k">else</span> <span class="n">ExitStack</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_before_trading_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_in_before_trading_start</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perf</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="n">ZiplineAPI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perf</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        N.B. this does not yet represent a string that can be used</span>
<span class="sd">        to instantiate an exact copy of an algorithm.</span>

<span class="sd">        However, it is getting close, and provides some value as something</span>
<span class="sd">        that can be inspected interactively.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{class_name}</span><span class="s2">(</span>
<span class="s2">    capital_base=</span><span class="si">{capital_base}</span><span class="s2"></span>
<span class="s2">    sim_params=</span><span class="si">{sim_params}</span><span class="s2">,</span>
<span class="s2">    initialized=</span><span class="si">{initialized}</span><span class="s2">,</span>
<span class="s2">    slippage_models=</span><span class="si">{slippage_models}</span><span class="s2">,</span>
<span class="s2">    commission_models=</span><span class="si">{commission_models}</span><span class="s2">,</span>
<span class="s2">    blotter=</span><span class="si">{blotter}</span><span class="s2">,</span>
<span class="s2">    recorded_vars=</span><span class="si">{recorded_vars}</span><span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                   <span class="n">capital_base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">capital_base</span><span class="p">,</span>
                   <span class="n">sim_params</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="p">),</span>
                   <span class="n">initialized</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">,</span>
                   <span class="n">slippage_models</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">slippage_models</span><span class="p">),</span>
                   <span class="n">commission_models</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">commission_models</span><span class="p">),</span>
                   <span class="n">blotter</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="p">),</span>
                   <span class="n">recorded_vars</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recorded_vars</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_create_clock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the clock property is not set, then create one based on frequency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trading_o_and_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">sessions</span><span class="p">]</span>
        <span class="n">market_closes</span> <span class="o">=</span> <span class="n">trading_o_and_c</span><span class="p">[</span><span class="s1">&#39;market_close&#39;</span><span class="p">]</span>
        <span class="n">minutely_emission</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">data_frequency</span> <span class="o">==</span> <span class="s1">&#39;minute&#39;</span><span class="p">:</span>
            <span class="n">market_opens</span> <span class="o">=</span> <span class="n">trading_o_and_c</span><span class="p">[</span><span class="s1">&#39;market_open&#39;</span><span class="p">]</span>
            <span class="n">minutely_emission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">emission_rate</span> <span class="o">==</span> <span class="s2">&quot;minute&quot;</span>

            <span class="c1"># The calendar&#39;s execution times are the minutes over which we</span>
            <span class="c1"># actually want to run the clock. Typically the execution times</span>
            <span class="c1"># simply adhere to the market open and close times. In the case of</span>
            <span class="c1"># the futures calendar, for example, we only want to simulate over</span>
            <span class="c1"># a subset of the full 24 hour calendar, so the execution times</span>
            <span class="c1"># dictate a market open time of 6:31am US/Eastern and a close of</span>
            <span class="c1"># 5:00pm US/Eastern.</span>
            <span class="n">execution_opens</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span><span class="o">.</span><span class="n">execution_time_from_open</span><span class="p">(</span><span class="n">market_opens</span><span class="p">)</span>
            <span class="n">execution_closes</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span><span class="o">.</span><span class="n">execution_time_from_close</span><span class="p">(</span><span class="n">market_closes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># in daily mode, we want to have one bar per session, timestamped</span>
            <span class="c1"># as the last minute of the session.</span>
            <span class="n">execution_closes</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span><span class="o">.</span><span class="n">execution_time_from_close</span><span class="p">(</span><span class="n">market_closes</span><span class="p">)</span>
            <span class="n">execution_opens</span> <span class="o">=</span> <span class="n">execution_closes</span>

        <span class="c1"># FIXME generalize these values</span>
        <span class="n">before_trading_start_minutes</span> <span class="o">=</span> <span class="n">days_at_time</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">sessions</span><span class="p">,</span>
            <span class="n">time</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>
            <span class="s2">&quot;US/Eastern&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">MinuteSimulationClock</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">sessions</span><span class="p">,</span>
            <span class="n">execution_opens</span><span class="p">,</span>
            <span class="n">execution_closes</span><span class="p">,</span>
            <span class="n">before_trading_start_minutes</span><span class="p">,</span>
            <span class="n">minute_emission</span><span class="o">=</span><span class="n">minutely_emission</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_benchmark_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_sid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">benchmark_asset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">retrieve_asset</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_sid</span>
            <span class="p">)</span>
            <span class="n">benchmark_returns</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_returns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoBenchmark</span><span class="p">()</span>
            <span class="n">benchmark_asset</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">benchmark_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_returns</span>
        <span class="k">return</span> <span class="n">BenchmarkSource</span><span class="p">(</span>
            <span class="n">benchmark_asset</span><span class="o">=</span><span class="n">benchmark_asset</span><span class="p">,</span>
            <span class="n">benchmark_returns</span><span class="o">=</span><span class="n">benchmark_returns</span><span class="p">,</span>
            <span class="n">trading_calendar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span><span class="p">,</span>
            <span class="n">sessions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">sessions</span><span class="p">,</span>
            <span class="n">data_portal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span><span class="p">,</span>
            <span class="n">emission_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">emission_rate</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_metrics_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MetricsTracker</span><span class="p">(</span>
            <span class="n">trading_calendar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span><span class="p">,</span>
            <span class="n">first_session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">start_session</span><span class="p">,</span>
            <span class="n">last_session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">end_session</span><span class="p">,</span>
            <span class="n">capital_base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">capital_base</span><span class="p">,</span>
            <span class="n">emission_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">emission_rate</span><span class="p">,</span>
            <span class="n">data_frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">data_frequency</span><span class="p">,</span>
            <span class="n">asset_finder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics_set</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sim_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span> <span class="o">=</span> <span class="n">sim_params</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_tracker</span> <span class="o">=</span> <span class="n">metrics_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_metrics_tracker</span><span class="p">()</span>

        <span class="c1"># Set the dt initially to the period start by forcing it to change.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_dt_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">start_session</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">initialize_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">benchmark_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_benchmark_source</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trading_client</span> <span class="o">=</span> <span class="n">AlgorithmSimulator</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">sim_params</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_clock</span><span class="p">(),</span>
            <span class="n">benchmark_source</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restrictions</span><span class="p">,</span>
            <span class="n">universe_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_calculate_universe</span>
        <span class="p">)</span>

        <span class="n">metrics_tracker</span><span class="o">.</span><span class="n">handle_start_of_simulation</span><span class="p">(</span><span class="n">benchmark_source</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trading_client</span><span class="o">.</span><span class="n">transform</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calculate_universe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># this exists to provide backwards compatibility for older,</span>
        <span class="c1"># deprecated APIs, particularly around the iterability of</span>
        <span class="c1"># BarData (ie, &#39;for sid in data`).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backwards_compat_universe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backwards_compat_universe</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">retrieve_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">sids</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backwards_compat_universe</span>

    <span class="k">def</span> <span class="nf">compute_eager_pipelines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute any pipelines attached with eager=True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">pipe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipelines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pipe</span><span class="o">.</span><span class="n">eager</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_output</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override this method to add new logic to the construction</span>
<span class="sd">        of the generator. Overrides can use the _create_generator</span>
<span class="sd">        method to get a standard construction generator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_generator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_portal</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the algorithm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># HACK: I don&#39;t think we really want to support passing a data portal</span>
        <span class="c1"># this late in the long term, but this is needed for now for backwards</span>
        <span class="c1"># compat downstream.</span>
        <span class="k">if</span> <span class="n">data_portal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span> <span class="o">=</span> <span class="n">data_portal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span> <span class="o">=</span> <span class="n">data_portal</span><span class="o">.</span><span class="n">asset_finder</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;No data portal in TradingAlgorithm.run().</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Either pass a DataPortal to TradingAlgorithm() or to run().&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
                <span class="s2">&quot;Have data portal without asset_finder.&quot;</span>

        <span class="c1"># Create zipline and loop through simulated_trading.</span>
        <span class="c1"># Each iteration returns a perf dictionary</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">perfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">perf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_generator</span><span class="p">():</span>
                <span class="n">perfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf</span><span class="p">)</span>

            <span class="c1"># convert perf dict to pandas dataframe</span>
            <span class="n">daily_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_daily_stats</span><span class="p">(</span><span class="n">perfs</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">daily_stats</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_tracker</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">daily_stats</span>

    <span class="k">def</span> <span class="nf">_create_daily_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perfs</span><span class="p">):</span>
        <span class="c1"># create daily and cumulative stats dataframe</span>
        <span class="n">daily_perfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># TODO: the loop here could overwrite expected properties</span>
        <span class="c1"># of daily_perf. Could potentially raise or log a</span>
        <span class="c1"># warning.</span>
        <span class="k">for</span> <span class="n">perf</span> <span class="ow">in</span> <span class="n">perfs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;daily_perf&#39;</span> <span class="ow">in</span> <span class="n">perf</span><span class="p">:</span>

                <span class="n">perf</span><span class="p">[</span><span class="s1">&#39;daily_perf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">perf</span><span class="p">[</span><span class="s1">&#39;daily_perf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;recorded_vars&#39;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">perf</span><span class="p">[</span><span class="s1">&#39;daily_perf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;cumulative_risk_metrics&#39;</span><span class="p">])</span>
                <span class="n">daily_perfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;daily_perf&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">risk_report</span> <span class="o">=</span> <span class="n">perf</span>

        <span class="n">daily_dts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span>
            <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;period_close&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">daily_perfs</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span>
        <span class="p">)</span>
        <span class="n">daily_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">daily_perfs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">daily_dts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">daily_stats</span>

    <span class="k">def</span> <span class="nf">calculate_capital_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">emission_rate</span><span class="p">,</span> <span class="n">is_interday</span><span class="p">,</span>
                                  <span class="n">portfolio_value_adjustment</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If there is a capital change for a given dt, this means the the change</span>
<span class="sd">        occurs before `handle_data` on the given dt. In the case of the</span>
<span class="sd">        change being a target value, the change will be computed on the</span>
<span class="sd">        portfolio value according to prices at the given dt</span>

<span class="sd">        `portfolio_value_adjustment`, if specified, will be removed from the</span>
<span class="sd">        portfolio_value of the cumulative performance when calculating deltas</span>
<span class="sd">        from target capital changes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">capital_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital_changes</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_last_sale_prices</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">capital_change</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">capital_change</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">capital_change_amount</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">target</span> <span class="o">-</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">-</span>
                    <span class="n">portfolio_value_adjustment</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing capital change to target </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">. Capital &#39;</span>
                     <span class="s1">&#39;change delta is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>
                                             <span class="n">capital_change_amount</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">capital_change</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;delta&#39;</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">capital_change_amount</span> <span class="o">=</span> <span class="n">capital_change</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing capital change of delta </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span>
                     <span class="o">%</span> <span class="p">(</span><span class="n">capital_change_amount</span><span class="p">,</span> <span class="n">dt</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Capital change </span><span class="si">%s</span><span class="s2"> does not indicate a valid type &quot;</span>
                      <span class="s2">&quot;(&#39;target&#39; or &#39;delta&#39;)&quot;</span> <span class="o">%</span> <span class="n">capital_change</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">capital_change_deltas</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">dt</span><span class="p">:</span> <span class="n">capital_change_amount</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_tracker</span><span class="o">.</span><span class="n">capital_change</span><span class="p">(</span><span class="n">capital_change_amount</span><span class="p">)</span>

        <span class="k">yield</span> <span class="p">{</span>
            <span class="s1">&#39;capital_change&#39;</span><span class="p">:</span>
                <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
                 <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cash&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
                 <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">capital_change_amount</span><span class="p">}</span>
        <span class="p">}</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">get_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s1">&#39;platform&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query the execution environment.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field : {&#39;platform&#39;, &#39;arena&#39;, &#39;data_frequency&#39;,</span>
<span class="sd">                 &#39;start&#39;, &#39;end&#39;, &#39;capital_base&#39;, &#39;platform&#39;, &#39;*&#39;}</span>
<span class="sd">            The field to query. The options have the following meanings:</span>
<span class="sd">              arena : str</span>
<span class="sd">                  The arena from the simulation parameters. This will normally</span>
<span class="sd">                  be ``&#39;backtest&#39;`` but some systems may use this distinguish</span>
<span class="sd">                  live trading from backtesting.</span>
<span class="sd">              data_frequency : {&#39;daily&#39;, &#39;minute&#39;}</span>
<span class="sd">                  data_frequency tells the algorithm if it is running with</span>
<span class="sd">                  daily data or minute data.</span>
<span class="sd">              start : datetime</span>
<span class="sd">                  The start date for the simulation.</span>
<span class="sd">              end : datetime</span>
<span class="sd">                  The end date for the simulation.</span>
<span class="sd">              capital_base : float</span>
<span class="sd">                  The starting capital for the simulation.</span>
<span class="sd">              platform : str</span>
<span class="sd">                  The platform that the code is running on. By default this</span>
<span class="sd">                  will be the string &#39;zipline&#39;. This can allow algorithms to</span>
<span class="sd">                  know if they are running on the Quantopian platform instead.</span>
<span class="sd">              * : dict[str -&gt; any]</span>
<span class="sd">                  Returns all of the fields in a dictionary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        val : any</span>
<span class="sd">            The value for the field queried. See above for more information.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised when ``field`` is not a valid option.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;arena&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">arena</span><span class="p">,</span>
            <span class="s1">&#39;data_frequency&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">data_frequency</span><span class="p">,</span>
            <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">first_open</span><span class="p">,</span>
            <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">last_close</span><span class="p">,</span>
            <span class="s1">&#39;capital_base&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">capital_base</span><span class="p">,</span>
            <span class="s1">&#39;platform&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_platform</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">env</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> is not a valid field for get_environment&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">fetch_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">url</span><span class="p">,</span>
                  <span class="n">pre_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">post_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">date_column</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                  <span class="n">date_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">timezone</span><span class="o">=</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">zone</span><span class="p">,</span>
                  <span class="n">symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">symbol_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">special_params_checker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">country_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch a csv from a remote url and register the data so that it is</span>
<span class="sd">        queryable from the ``data`` object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        url : str</span>
<span class="sd">            The url of the csv file to load.</span>
<span class="sd">        pre_func : callable[pd.DataFrame -&gt; pd.DataFrame], optional</span>
<span class="sd">            A callback to allow preprocessing the raw data returned from</span>
<span class="sd">            fetch_csv before dates are paresed or symbols are mapped.</span>
<span class="sd">        post_func : callable[pd.DataFrame -&gt; pd.DataFrame], optional</span>
<span class="sd">            A callback to allow postprocessing of the data after dates and</span>
<span class="sd">            symbols have been mapped.</span>
<span class="sd">        date_column : str, optional</span>
<span class="sd">            The name of the column in the preprocessed dataframe containing</span>
<span class="sd">            datetime information to map the data.</span>
<span class="sd">        date_format : str, optional</span>
<span class="sd">            The format of the dates in the ``date_column``. If not provided</span>
<span class="sd">            ``fetch_csv`` will attempt to infer the format. For information</span>
<span class="sd">            about the format of this string, see :func:`pandas.read_csv`.</span>
<span class="sd">        timezone : tzinfo or str, optional</span>
<span class="sd">            The timezone for the datetime in the ``date_column``.</span>
<span class="sd">        symbol : str, optional</span>
<span class="sd">            If the data is about a new asset or index then this string will</span>
<span class="sd">            be the name used to identify the values in ``data``. For example,</span>
<span class="sd">            one may use ``fetch_csv`` to load data for VIX, then this field</span>
<span class="sd">            could be the string ``&#39;VIX&#39;``.</span>
<span class="sd">        mask : bool, optional</span>
<span class="sd">            Drop any rows which cannot be symbol mapped.</span>
<span class="sd">        symbol_column : str</span>
<span class="sd">            If the data is attaching some new attribute to each asset then this</span>
<span class="sd">            argument is the name of the column in the preprocessed dataframe</span>
<span class="sd">            containing the symbols. This will be used along with the date</span>
<span class="sd">            information to map the sids in the asset finder.</span>
<span class="sd">        country_code : str, optional</span>
<span class="sd">            Country code to use to disambiguate symbol lookups.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Forwarded to :func:`pandas.read_csv`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        csv_data_source : zipline.sources.requests_csv.PandasRequestsCSV</span>
<span class="sd">            A requests source that will pull data from the url specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">country_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">country_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_fetch_csv_country_code</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Show all the logs every time fetcher is used.</span>
        <span class="n">csv_data_source</span> <span class="o">=</span> <span class="n">PandasRequestsCSV</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">pre_func</span><span class="p">,</span>
            <span class="n">post_func</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">start_session</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">end_session</span><span class="p">,</span>
            <span class="n">date_column</span><span class="p">,</span>
            <span class="n">date_format</span><span class="p">,</span>
            <span class="n">timezone</span><span class="p">,</span>
            <span class="n">symbol</span><span class="p">,</span>
            <span class="n">mask</span><span class="p">,</span>
            <span class="n">symbol_column</span><span class="p">,</span>
            <span class="n">data_frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_frequency</span><span class="p">,</span>
            <span class="n">country_code</span><span class="o">=</span><span class="n">country_code</span><span class="p">,</span>
            <span class="n">special_params_checker</span><span class="o">=</span><span class="n">special_params_checker</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># ingest this into dataportal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span><span class="o">.</span><span class="n">handle_extra_source</span><span class="p">(</span><span class="n">csv_data_source</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">csv_data_source</span>

    <span class="k">def</span> <span class="nf">add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds an event to the algorithm&#39;s EventManager.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rule : EventRule</span>
<span class="sd">            The rule for when the callback should be triggered.</span>
<span class="sd">        callback : callable[(context, data) -&gt; None]</span>
<span class="sd">            The function to execute when the rule is triggered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_manager</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span>
            <span class="n">zipline</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">callback</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">schedule_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">func</span><span class="p">,</span>
                          <span class="n">date_rule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">time_rule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">half_days</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">calendar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schedule a function to be called repeatedly in the future.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : callable</span>
<span class="sd">            The function to execute when the rule is triggered. ``func`` should</span>
<span class="sd">            have the same signature as ``handle_data``.</span>
<span class="sd">        date_rule : zipline.utils.events.EventRule, optional</span>
<span class="sd">            Rule for the dates on which to execute ``func``. If not</span>
<span class="sd">            passed, the function will run every trading day.</span>
<span class="sd">        time_rule : zipline.utils.events.EventRule, optional</span>
<span class="sd">            Rule for the time at which to execute ``func``. If not passed, the</span>
<span class="sd">            function will execute at the end of the first market minute of the</span>
<span class="sd">            day.</span>
<span class="sd">        half_days : bool, optional</span>
<span class="sd">            Should this rule fire on half days? Default is True.</span>
<span class="sd">        calendar : Sentinel, optional</span>
<span class="sd">            Calendar used to compute rules that depend on the trading calendar.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :class:`zipline.api.date_rules`</span>
<span class="sd">        :class:`zipline.api.time_rules`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># When the user calls schedule_function(func, &lt;time_rule&gt;), assume that</span>
        <span class="c1"># the user meant to specify a time rule but no date rule, instead of</span>
        <span class="c1"># a date rule and no time rule as the signature suggests</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_rule</span><span class="p">,</span> <span class="p">(</span><span class="n">AfterOpen</span><span class="p">,</span> <span class="n">BeforeClose</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">time_rule</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Got a time rule for the second positional argument &#39;</span>
                          <span class="s1">&#39;date_rule. You should use keyword argument &#39;</span>
                          <span class="s1">&#39;time_rule= when calling schedule_function without &#39;</span>
                          <span class="s1">&#39;specifying a date_rule&#39;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">date_rule</span> <span class="o">=</span> <span class="n">date_rule</span> <span class="ow">or</span> <span class="n">date_rules</span><span class="o">.</span><span class="n">every_day</span><span class="p">()</span>
        <span class="n">time_rule</span> <span class="o">=</span> <span class="p">((</span><span class="n">time_rule</span> <span class="ow">or</span> <span class="n">time_rules</span><span class="o">.</span><span class="n">every_minute</span><span class="p">())</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">data_frequency</span> <span class="o">==</span> <span class="s1">&#39;minute&#39;</span> <span class="k">else</span>
                     <span class="c1"># If we are in daily mode the time_rule is ignored.</span>
                     <span class="n">time_rules</span><span class="o">.</span><span class="n">every_minute</span><span class="p">())</span>

        <span class="c1"># Check the type of the algorithm&#39;s schedule before pulling calendar</span>
        <span class="c1"># Note that the ExchangeTradingSchedule is currently the only</span>
        <span class="c1"># TradingSchedule class, so this is unlikely to be hit</span>
        <span class="k">if</span> <span class="n">calendar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span>
        <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">is</span> <span class="n">calendars</span><span class="o">.</span><span class="n">US_EQUITIES</span><span class="p">:</span>
            <span class="n">cal</span> <span class="o">=</span> <span class="n">get_calendar</span><span class="p">(</span><span class="s1">&#39;XNYS&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">is</span> <span class="n">calendars</span><span class="o">.</span><span class="n">US_FUTURES</span><span class="p">:</span>
            <span class="n">cal</span> <span class="o">=</span> <span class="n">get_calendar</span><span class="p">(</span><span class="s1">&#39;us_futures&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScheduleFunctionInvalidCalendar</span><span class="p">(</span>
                <span class="n">given_calendar</span><span class="o">=</span><span class="n">calendar</span><span class="p">,</span>
                <span class="n">allowed_calendars</span><span class="o">=</span><span class="p">(</span>
                    <span class="s1">&#39;[calendars.US_EQUITIES, calendars.US_FUTURES]&#39;</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span>
            <span class="n">make_eventrule</span><span class="p">(</span><span class="n">date_rule</span><span class="p">,</span> <span class="n">time_rule</span><span class="p">,</span> <span class="n">cal</span><span class="p">,</span> <span class="n">half_days</span><span class="p">),</span>
            <span class="n">func</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Track and record values each day.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs</span>
<span class="sd">            The names and values to record.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        These values will appear in the performance packets and the performance</span>
<span class="sd">        dataframe passed to ``analyze`` and returned from</span>
<span class="sd">        :func:`~zipline.run_algorithm`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make 2 objects both referencing the same iterator</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">args</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="c1"># Zip generates list entries by calling `next` on each iterator it</span>
        <span class="c1"># receives.  In this case the two iterators are the same object, so the</span>
        <span class="c1"># call to next on args[0] will also advance args[1], resulting in zip</span>
        <span class="c1"># returning (a,b) (c,d) (e,f) rather than (a,a) (b,b) (c,c) etc.</span>
        <span class="n">positionals</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">positionals</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recorded_vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_benchmark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">benchmark</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the benchmark asset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        benchmark : zipline.assets.Asset</span>
<span class="sd">            The asset to set as the new benchmark.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Any dividends payed out for that new benchmark asset will be</span>
<span class="sd">        automatically reinvested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SetBenchmarkOutsideInitialize</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_sid</span> <span class="o">=</span> <span class="n">benchmark</span>

    <span class="nd">@api_method</span>
    <span class="nd">@preprocess</span><span class="p">(</span><span class="n">root_symbol_str</span><span class="o">=</span><span class="n">ensure_upper_case</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">continuous_future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">root_symbol_str</span><span class="p">,</span>
                          <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">roll</span><span class="o">=</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span>
                          <span class="n">adjustment</span><span class="o">=</span><span class="s1">&#39;mul&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a specifier for a continuous contract.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        root_symbol_str : str</span>
<span class="sd">            The root symbol for the future chain.</span>

<span class="sd">        offset : int, optional</span>
<span class="sd">            The distance from the primary contract. Default is 0.</span>

<span class="sd">        roll_style : str, optional</span>
<span class="sd">            How rolls are determined. Default is &#39;volume&#39;.</span>

<span class="sd">        adjustment : str, optional</span>
<span class="sd">            Method for adjusting lookback prices between rolls. Options are</span>
<span class="sd">            &#39;mul&#39;, &#39;add&#39;, and None. Default is &#39;mul&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        continuous_future : zipline.assets.ContinuousFuture</span>
<span class="sd">            The continuous future specifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">create_continuous_future</span><span class="p">(</span>
            <span class="n">root_symbol_str</span><span class="p">,</span>
            <span class="n">offset</span><span class="p">,</span>
            <span class="n">roll</span><span class="p">,</span>
            <span class="n">adjustment</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="nd">@preprocess</span><span class="p">(</span>
        <span class="n">symbol_str</span><span class="o">=</span><span class="n">ensure_upper_case</span><span class="p">,</span>
        <span class="n">country_code</span><span class="o">=</span><span class="n">optionally</span><span class="p">(</span><span class="n">ensure_upper_case</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol_str</span><span class="p">,</span> <span class="n">country_code</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lookup an Equity by its ticker symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol_str : str</span>
<span class="sd">            The ticker symbol for the equity to lookup.</span>
<span class="sd">        country_code : str or None, optional</span>
<span class="sd">            A country to limit symbol searches to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        equity : zipline.assets.Equity</span>
<span class="sd">            The equity that held the ticker symbol on the current</span>
<span class="sd">            symbol lookup date.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        SymbolNotFound</span>
<span class="sd">            Raised when the symbols was not held on the current lookup date.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`zipline.api.set_symbol_lookup_date`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the user has not set the symbol lookup date,</span>
        <span class="c1"># use the end_session as the date for symbol-&gt;sid resolution.</span>
        <span class="n">_lookup_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbol_lookup_date</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbol_lookup_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">end_session</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_symbol</span><span class="p">(</span>
            <span class="n">symbol_str</span><span class="p">,</span>
            <span class="n">as_of_date</span><span class="o">=</span><span class="n">_lookup_date</span><span class="p">,</span>
            <span class="n">country_code</span><span class="o">=</span><span class="n">country_code</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lookup multuple Equities as a list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *args : iterable[str]</span>
<span class="sd">            The ticker symbols to lookup.</span>
<span class="sd">        country_code : str or None, optional</span>
<span class="sd">            A country to limit symbol searches to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        equities : list[zipline.assets.Equity]</span>
<span class="sd">            The equities that held the given ticker symbols on the current</span>
<span class="sd">            symbol lookup date.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        SymbolNotFound</span>
<span class="sd">            Raised when one of the symbols was not held on the current</span>
<span class="sd">            lookup date.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`zipline.api.set_symbol_lookup_date`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">sid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lookup an Asset by its unique asset identifier.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sid : int</span>
<span class="sd">            The unique integer that identifies an asset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        asset : zipline.assets.Asset</span>
<span class="sd">            The asset with the given ``sid``.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        SidsNotFound</span>
<span class="sd">            When a requested ``sid`` does not map to any asset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">retrieve_asset</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="nd">@preprocess</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="n">ensure_upper_case</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">future_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lookup a futures contract with a given symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : str</span>
<span class="sd">            The symbol of the desired contract.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        future : zipline.assets.Future</span>
<span class="sd">            The future that trades with the name ``symbol``.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        SymbolNotFound</span>
<span class="sd">            Raised when no contract named &#39;symbol&#39; is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_future_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_order_value_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates how many shares/contracts to order based on the type of</span>
<span class="sd">        asset being ordered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure the asset exists, and that there is a last price for it.</span>
        <span class="c1"># FIXME: we should use BarData&#39;s can_trade logic here, but I haven&#39;t</span>
        <span class="c1"># yet found a good way to do that.</span>
        <span class="n">normalized_date</span> <span class="o">=</span> <span class="n">normalize_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">normalized_date</span> <span class="o">&lt;</span> <span class="n">asset</span><span class="o">.</span><span class="n">start_date</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotOrderDelistedAsset</span><span class="p">(</span>
                <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Cannot order </span><span class="si">{0}</span><span class="s2">, as it started trading on&quot;</span>
                    <span class="s2">&quot; </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">normalized_date</span> <span class="o">&gt;</span> <span class="n">asset</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotOrderDelistedAsset</span><span class="p">(</span>
                <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Cannot order </span><span class="si">{0}</span><span class="s2">, as it stopped trading on&quot;</span>
                    <span class="s2">&quot; </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">end_date</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_price</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">trading_client</span><span class="o">.</span><span class="n">current_data</span><span class="o">.</span><span class="n">current</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">last_price</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CannotOrderDelistedAsset</span><span class="p">(</span>
                    <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Cannot order </span><span class="si">{0}</span><span class="s2"> on </span><span class="si">{1}</span><span class="s2"> as there is no last &quot;</span>
                        <span class="s2">&quot;price for the security.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">tolerant_equals</span><span class="p">(</span><span class="n">last_price</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">zero_message</span> <span class="o">=</span> <span class="s2">&quot;Price of 0 for </span><span class="si">{psid}</span><span class="s2">; can&#39;t infer value&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">psid</span><span class="o">=</span><span class="n">asset</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">zero_message</span><span class="p">)</span>
            <span class="c1"># Don&#39;t place any order</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">value_multiplier</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">price_multiplier</span>

        <span class="k">return</span> <span class="n">value</span> <span class="o">/</span> <span class="p">(</span><span class="n">last_price</span> <span class="o">*</span> <span class="n">value_multiplier</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_can_order_asset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">Asset</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UnsupportedOrderParameters</span><span class="p">(</span>
                <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Passing non-Asset argument to &#39;order()&#39; is not supported.&quot;</span>
                    <span class="s2">&quot; Use &#39;sid()&#39; or &#39;symbol()&#39; methods to look up an Asset.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">asset</span><span class="o">.</span><span class="n">auto_close_date</span><span class="p">:</span>
            <span class="n">day</span> <span class="o">=</span> <span class="n">normalize_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_datetime</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">day</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">end_date</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">auto_close_date</span><span class="p">):</span>
                <span class="c1"># If we are after the asset&#39;s end date or auto close date, warn</span>
                <span class="c1"># the user that they can&#39;t place an order for this asset, and</span>
                <span class="c1"># return None.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot place order for </span><span class="si">{0}</span><span class="s2">, as it has de-listed. &quot;</span>
                         <span class="s2">&quot;Any existing positions for this asset will be &quot;</span>
                         <span class="s2">&quot;liquidated on &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">auto_close_date</span><span class="p">))</span>

                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@api_method</span>
    <span class="nd">@disallowed_in_before_trading_start</span><span class="p">(</span><span class="n">OrderInBeforeTradingStart</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">asset</span><span class="p">,</span>
              <span class="n">amount</span><span class="p">,</span>
              <span class="n">limit_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">stop_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place an order for a fixed number of shares.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        asset : Asset</span>
<span class="sd">            The asset to be ordered.</span>
<span class="sd">        amount : int</span>
<span class="sd">            The amount of shares to order. If ``amount`` is positive, this is</span>
<span class="sd">            the number of shares to buy or cover. If ``amount`` is negative,</span>
<span class="sd">            this is the number of shares to sell or short.</span>
<span class="sd">        limit_price : float, optional</span>
<span class="sd">            The limit price for the order.</span>
<span class="sd">        stop_price : float, optional</span>
<span class="sd">            The stop price for the order.</span>
<span class="sd">        style : ExecutionStyle, optional</span>
<span class="sd">            The execution style for the order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        order_id : str or None</span>
<span class="sd">            The unique identifier for this order, or None if no order was</span>
<span class="sd">            placed.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The ``limit_price`` and ``stop_price`` arguments provide shorthands for</span>
<span class="sd">        passing common execution styles. Passing ``limit_price=N`` is</span>
<span class="sd">        equivalent to ``style=LimitOrder(N)``. Similarly, passing</span>
<span class="sd">        ``stop_price=M`` is equivalent to ``style=StopOrder(M)``, and passing</span>
<span class="sd">        ``limit_price=N`` and ``stop_price=M`` is equivalent to</span>
<span class="sd">        ``style=StopLimitOrder(N, M)``. It is an error to pass both a ``style``</span>
<span class="sd">        and ``limit_price`` or ``stop_price``.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :class:`zipline.finance.execution.ExecutionStyle`</span>
<span class="sd">        :func:`zipline.api.order_value`</span>
<span class="sd">        :func:`zipline.api.order_percent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_order_asset</span><span class="p">(</span><span class="n">asset</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">amount</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span>
                                              <span class="n">limit_price</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span>
                         <span class="n">limit_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">round_order</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>

        <span class="c1"># Raises a ZiplineError if invalid parameters are detected.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_order_params</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span>
                                   <span class="n">amount</span><span class="p">,</span>
                                   <span class="n">limit_price</span><span class="p">,</span>
                                   <span class="n">stop_price</span><span class="p">,</span>
                                   <span class="n">style</span><span class="p">)</span>

        <span class="c1"># Convert deprecated limit_price and stop_price parameters to use</span>
        <span class="c1"># ExecutionStyle objects.</span>
        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__convert_order_params_for_blotter</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span>
                                                        <span class="n">limit_price</span><span class="p">,</span>
                                                        <span class="n">stop_price</span><span class="p">,</span>
                                                        <span class="n">style</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">amount</span><span class="p">,</span> <span class="n">style</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">round_order</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert number of shares to an integer.</span>

<span class="sd">        By default, truncates to the integer share count that&#39;s either within</span>
<span class="sd">        .0001 of amount or closer to zero.</span>

<span class="sd">        E.g. 3.9999 -&gt; 4.0; 5.5 -&gt; 5.0; -5.5 -&gt; -5.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">round_if_near_integer</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_order_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">asset</span><span class="p">,</span>
                              <span class="n">amount</span><span class="p">,</span>
                              <span class="n">limit_price</span><span class="p">,</span>
                              <span class="n">stop_price</span><span class="p">,</span>
                              <span class="n">style</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method for validating parameters to the order API function.</span>

<span class="sd">        Raises an UnsupportedOrderParameters if invalid arguments are found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OrderDuringInitialize</span><span class="p">(</span>
                <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;order() can only be called from within handle_data()&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">limit_price</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnsupportedOrderParameters</span><span class="p">(</span>
                    <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Passing both limit_price and style is not supported.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">stop_price</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnsupportedOrderParameters</span><span class="p">(</span>
                    <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Passing both stop_price and style is not supported.&quot;</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trading_controls</span><span class="p">:</span>
            <span class="n">control</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span>
                             <span class="n">amount</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">get_datetime</span><span class="p">(),</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">trading_client</span><span class="o">.</span><span class="n">current_data</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__convert_order_params_for_blotter</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span>
                                           <span class="n">limit_price</span><span class="p">,</span>
                                           <span class="n">stop_price</span><span class="p">,</span>
                                           <span class="n">style</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method for converting deprecated limit_price and stop_price</span>
<span class="sd">        arguments into ExecutionStyle instances.</span>

<span class="sd">        This function assumes that either style == None or (limit_price,</span>
<span class="sd">        stop_price) == (None, None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">limit_price</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">style</span>
        <span class="k">if</span> <span class="n">limit_price</span> <span class="ow">and</span> <span class="n">stop_price</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">StopLimitOrder</span><span class="p">(</span><span class="n">limit_price</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">limit_price</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LimitOrder</span><span class="p">(</span><span class="n">limit_price</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stop_price</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">StopOrder</span><span class="p">(</span><span class="n">stop_price</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MarketOrder</span><span class="p">()</span>

    <span class="nd">@api_method</span>
    <span class="nd">@disallowed_in_before_trading_start</span><span class="p">(</span><span class="n">OrderInBeforeTradingStart</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">order_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">asset</span><span class="p">,</span>
                    <span class="n">value</span><span class="p">,</span>
                    <span class="n">limit_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">stop_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Place an order for a fixed amount of money.</span>

<span class="sd">        Equivalent to ``order(asset, value / data.current(asset, &#39;price&#39;))``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        asset : Asset</span>
<span class="sd">            The asset to be ordered.</span>
<span class="sd">        value : float</span>
<span class="sd">            Amount of value of ``asset`` to be transacted. The number of shares</span>
<span class="sd">            bought or sold will be equal to ``value / current_price``.</span>
<span class="sd">        limit_price : float, optional</span>
<span class="sd">            Limit price for the order.</span>
<span class="sd">        stop_price : float, optional</span>
<span class="sd">            Stop price for the order.</span>
<span class="sd">        style : ExecutionStyle</span>
<span class="sd">            The execution style for the order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        order_id : str</span>
<span class="sd">            The unique identifier for this order.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        See :func:`zipline.api.order` for more information about</span>
<span class="sd">        ``limit_price``, ``stop_price``, and ``style``</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :class:`zipline.finance.execution.ExecutionStyle`</span>
<span class="sd">        :func:`zipline.api.order`</span>
<span class="sd">        :func:`zipline.api.order_percent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_order_asset</span><span class="p">(</span><span class="n">asset</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order_value_amount</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span>
                          <span class="n">limit_price</span><span class="o">=</span><span class="n">limit_price</span><span class="p">,</span>
                          <span class="n">stop_price</span><span class="o">=</span><span class="n">stop_price</span><span class="p">,</span>
                          <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">recorded_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recorded_vars</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sync_last_sale_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sync the last sale prices on the metrics tracker to a given</span>
<span class="sd">        datetime.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dt : datetime</span>
<span class="sd">            The time to sync the prices to.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This call is cached by the datetime. Repeated calls in the same bar</span>
<span class="sd">        are cheap.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span>

        <span class="k">if</span> <span class="n">dt</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_sync_time</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_tracker</span><span class="o">.</span><span class="n">sync_last_sale_prices</span><span class="p">(</span>
                <span class="n">dt</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_sync_time</span> <span class="o">=</span> <span class="n">dt</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">portfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_last_sale_prices</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_tracker</span><span class="o">.</span><span class="n">portfolio</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">account</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_last_sale_prices</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_tracker</span><span class="o">.</span><span class="n">account</span>

    <span class="k">def</span> <span class="nf">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>

    <span class="k">def</span> <span class="nf">on_dt_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback triggered by the simulation loop whenever the current dt</span>
<span class="sd">        changes.</span>

<span class="sd">        Any logic that should happen exactly once at the start of each datetime</span>
<span class="sd">        group should happen here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">set_date</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="nd">@preprocess</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">coerce_string</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">))</span>
    <span class="nd">@expect_types</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">optional</span><span class="p">(</span><span class="n">tzinfo</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">get_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current simulation datetime.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tz : tzinfo or str, optional</span>
<span class="sd">            The timezone to return the datetime in. This defaults to utc.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dt : datetime</span>
<span class="sd">            The current simulation datetime converted to ``tz``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span>
        <span class="k">assert</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="o">==</span> <span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">,</span> <span class="s2">&quot;Algorithm should have a utc datetime&quot;</span>
        <span class="k">if</span> <span class="n">tz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dt</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_slippage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">us_equities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">us_futures</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the slippage models for the simulation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        us_equities : EquitySlippageModel</span>
<span class="sd">            The slippage model to use for trading US equities.</span>
<span class="sd">        us_futures : FutureSlippageModel</span>
<span class="sd">            The slippage model to use for trading US futures.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function can only be called during</span>
<span class="sd">        :func:`~zipline.api.initialize`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :class:`zipline.finance.slippage.SlippageModel`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SetSlippagePostInit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">us_equities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Equity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">us_equities</span><span class="o">.</span><span class="n">allowed_asset_types</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IncompatibleSlippageModel</span><span class="p">(</span>
                    <span class="n">asset_type</span><span class="o">=</span><span class="s1">&#39;equities&#39;</span><span class="p">,</span>
                    <span class="n">given_model</span><span class="o">=</span><span class="n">us_equities</span><span class="p">,</span>
                    <span class="n">supported_asset_types</span><span class="o">=</span><span class="n">us_equities</span><span class="o">.</span><span class="n">allowed_asset_types</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">slippage_models</span><span class="p">[</span><span class="n">Equity</span><span class="p">]</span> <span class="o">=</span> <span class="n">us_equities</span>

        <span class="k">if</span> <span class="n">us_futures</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Future</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">us_futures</span><span class="o">.</span><span class="n">allowed_asset_types</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IncompatibleSlippageModel</span><span class="p">(</span>
                    <span class="n">asset_type</span><span class="o">=</span><span class="s1">&#39;futures&#39;</span><span class="p">,</span>
                    <span class="n">given_model</span><span class="o">=</span><span class="n">us_futures</span><span class="p">,</span>
                    <span class="n">supported_asset_types</span><span class="o">=</span><span class="n">us_futures</span><span class="o">.</span><span class="n">allowed_asset_types</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">slippage_models</span><span class="p">[</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="n">us_futures</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_commission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">us_equities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">us_futures</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the commission models for the simulation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        us_equities : EquityCommissionModel</span>
<span class="sd">            The commission model to use for trading US equities.</span>
<span class="sd">        us_futures : FutureCommissionModel</span>
<span class="sd">            The commission model to use for trading US futures.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function can only be called during</span>
<span class="sd">        :func:`~zipline.api.initialize`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :class:`zipline.finance.commission.PerShare`</span>
<span class="sd">        :class:`zipline.finance.commission.PerTrade`</span>
<span class="sd">        :class:`zipline.finance.commission.PerDollar`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SetCommissionPostInit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">us_equities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Equity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">us_equities</span><span class="o">.</span><span class="n">allowed_asset_types</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IncompatibleCommissionModel</span><span class="p">(</span>
                    <span class="n">asset_type</span><span class="o">=</span><span class="s1">&#39;equities&#39;</span><span class="p">,</span>
                    <span class="n">given_model</span><span class="o">=</span><span class="n">us_equities</span><span class="p">,</span>
                    <span class="n">supported_asset_types</span><span class="o">=</span><span class="n">us_equities</span><span class="o">.</span><span class="n">allowed_asset_types</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">commission_models</span><span class="p">[</span><span class="n">Equity</span><span class="p">]</span> <span class="o">=</span> <span class="n">us_equities</span>

        <span class="k">if</span> <span class="n">us_futures</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Future</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">us_futures</span><span class="o">.</span><span class="n">allowed_asset_types</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IncompatibleCommissionModel</span><span class="p">(</span>
                    <span class="n">asset_type</span><span class="o">=</span><span class="s1">&#39;futures&#39;</span><span class="p">,</span>
                    <span class="n">given_model</span><span class="o">=</span><span class="n">us_futures</span><span class="p">,</span>
                    <span class="n">supported_asset_types</span><span class="o">=</span><span class="n">us_futures</span><span class="o">.</span><span class="n">allowed_asset_types</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">commission_models</span><span class="p">[</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="n">us_futures</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_cancel_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cancel_policy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the order cancellation policy for the simulation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cancel_policy : CancelPolicy</span>
<span class="sd">            The cancellation policy to use.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :class:`zipline.api.EODCancel`</span>
<span class="sd">        :class:`zipline.api.NeverCancel`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cancel_policy</span><span class="p">,</span> <span class="n">CancelPolicy</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UnsupportedCancelPolicy</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SetCancelPolicyPostInit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">cancel_policy</span> <span class="o">=</span> <span class="n">cancel_policy</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_symbol_lookup_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the date for which symbols will be resolved to their assets</span>
<span class="sd">        (symbols may map to different firms or underlying assets at</span>
<span class="sd">        different times)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dt : datetime</span>
<span class="sd">            The new symbol lookup date.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_symbol_lookup_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsupportedDatetimeFormat</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;set_symbol_lookup_date&#39;</span><span class="p">)</span>

    <span class="c1"># Remain backwards compatibility</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">data_frequency</span>

    <span class="nd">@data_frequency</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">data_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">data_frequency</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@api_method</span>
    <span class="nd">@disallowed_in_before_trading_start</span><span class="p">(</span><span class="n">OrderInBeforeTradingStart</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">order_percent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">asset</span><span class="p">,</span>
                      <span class="n">percent</span><span class="p">,</span>
                      <span class="n">limit_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">stop_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place an order in the specified asset corresponding to the given</span>
<span class="sd">        percent of the current portfolio value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        asset : Asset</span>
<span class="sd">            The asset that this order is for.</span>
<span class="sd">        percent : float</span>
<span class="sd">            The percentage of the portfolio value to allocate to ``asset``.</span>
<span class="sd">            This is specified as a decimal, for example: 0.50 means 50%.</span>
<span class="sd">        limit_price : float, optional</span>
<span class="sd">            The limit price for the order.</span>
<span class="sd">        stop_price : float, optional</span>
<span class="sd">            The stop price for the order.</span>
<span class="sd">        style : ExecutionStyle</span>
<span class="sd">            The execution style for the order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        order_id : str</span>
<span class="sd">            The unique identifier for this order.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        See :func:`zipline.api.order` for more information about</span>
<span class="sd">        ``limit_price``, ``stop_price``, and ``style``</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :class:`zipline.finance.execution.ExecutionStyle`</span>
<span class="sd">        :func:`zipline.api.order`</span>
<span class="sd">        :func:`zipline.api.order_value`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_order_asset</span><span class="p">(</span><span class="n">asset</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order_percent_amount</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">percent</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span>
                          <span class="n">limit_price</span><span class="o">=</span><span class="n">limit_price</span><span class="p">,</span>
                          <span class="n">stop_price</span><span class="o">=</span><span class="n">stop_price</span><span class="p">,</span>
                          <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_order_percent_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">percent</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">*</span> <span class="n">percent</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order_value_amount</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="nd">@disallowed_in_before_trading_start</span><span class="p">(</span><span class="n">OrderInBeforeTradingStart</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">order_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">asset</span><span class="p">,</span>
                     <span class="n">target</span><span class="p">,</span>
                     <span class="n">limit_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">stop_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place an order to adjust a position to a target number of shares. If</span>
<span class="sd">        the position doesn&#39;t already exist, this is equivalent to placing a new</span>
<span class="sd">        order. If the position does exist, this is equivalent to placing an</span>
<span class="sd">        order for the difference between the target number of shares and the</span>
<span class="sd">        current number of shares.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        asset : Asset</span>
<span class="sd">            The asset that this order is for.</span>
<span class="sd">        target : int</span>
<span class="sd">            The desired number of shares of ``asset``.</span>
<span class="sd">        limit_price : float, optional</span>
<span class="sd">            The limit price for the order.</span>
<span class="sd">        stop_price : float, optional</span>
<span class="sd">            The stop price for the order.</span>
<span class="sd">        style : ExecutionStyle</span>
<span class="sd">            The execution style for the order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        order_id : str</span>
<span class="sd">            The unique identifier for this order.</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        ``order_target`` does not take into account any open orders. For</span>
<span class="sd">        example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">           order_target(sid(0), 10)</span>
<span class="sd">           order_target(sid(0), 10)</span>

<span class="sd">        This code will result in 20 shares of ``sid(0)`` because the first</span>
<span class="sd">        call to ``order_target`` will not have been filled when the second</span>
<span class="sd">        ``order_target`` call is made.</span>

<span class="sd">        See :func:`zipline.api.order` for more information about</span>
<span class="sd">        ``limit_price``, ``stop_price``, and ``style``</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :class:`zipline.finance.execution.ExecutionStyle`</span>
<span class="sd">        :func:`zipline.api.order`</span>
<span class="sd">        :func:`zipline.api.order_target_percent`</span>
<span class="sd">        :func:`zipline.api.order_target_value`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_order_asset</span><span class="p">(</span><span class="n">asset</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order_target_amount</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span>
                          <span class="n">limit_price</span><span class="o">=</span><span class="n">limit_price</span><span class="p">,</span>
                          <span class="n">stop_price</span><span class="o">=</span><span class="n">stop_price</span><span class="p">,</span>
                          <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_order_target_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">asset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="n">current_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span><span class="o">.</span><span class="n">amount</span>
            <span class="n">target</span> <span class="o">-=</span> <span class="n">current_position</span>

        <span class="k">return</span> <span class="n">target</span>

    <span class="nd">@api_method</span>
    <span class="nd">@disallowed_in_before_trading_start</span><span class="p">(</span><span class="n">OrderInBeforeTradingStart</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">order_target_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">asset</span><span class="p">,</span>
                           <span class="n">target</span><span class="p">,</span>
                           <span class="n">limit_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">stop_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place an order to adjust a position to a target value. If</span>
<span class="sd">        the position doesn&#39;t already exist, this is equivalent to placing a new</span>
<span class="sd">        order. If the position does exist, this is equivalent to placing an</span>
<span class="sd">        order for the difference between the target value and the</span>
<span class="sd">        current value.</span>
<span class="sd">        If the Asset being ordered is a Future, the &#39;target value&#39; calculated</span>
<span class="sd">        is actually the target exposure, as Futures have no &#39;value&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        asset : Asset</span>
<span class="sd">            The asset that this order is for.</span>
<span class="sd">        target : float</span>
<span class="sd">            The desired total value of ``asset``.</span>
<span class="sd">        limit_price : float, optional</span>
<span class="sd">            The limit price for the order.</span>
<span class="sd">        stop_price : float, optional</span>
<span class="sd">            The stop price for the order.</span>
<span class="sd">        style : ExecutionStyle</span>
<span class="sd">            The execution style for the order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        order_id : str</span>
<span class="sd">            The unique identifier for this order.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        ``order_target_value`` does not take into account any open orders. For</span>
<span class="sd">        example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">           order_target_value(sid(0), 10)</span>
<span class="sd">           order_target_value(sid(0), 10)</span>

<span class="sd">        This code will result in 20 dollars of ``sid(0)`` because the first</span>
<span class="sd">        call to ``order_target_value`` will not have been filled when the</span>
<span class="sd">        second ``order_target_value`` call is made.</span>

<span class="sd">        See :func:`zipline.api.order` for more information about</span>
<span class="sd">        ``limit_price``, ``stop_price``, and ``style``</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :class:`zipline.finance.execution.ExecutionStyle`</span>
<span class="sd">        :func:`zipline.api.order`</span>
<span class="sd">        :func:`zipline.api.order_target`</span>
<span class="sd">        :func:`zipline.api.order_target_percent`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_order_asset</span><span class="p">(</span><span class="n">asset</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">target_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order_value_amount</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order_target_amount</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">target_amount</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span>
                          <span class="n">limit_price</span><span class="o">=</span><span class="n">limit_price</span><span class="p">,</span>
                          <span class="n">stop_price</span><span class="o">=</span><span class="n">stop_price</span><span class="p">,</span>
                          <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="nd">@disallowed_in_before_trading_start</span><span class="p">(</span><span class="n">OrderInBeforeTradingStart</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">order_target_percent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                             <span class="n">limit_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place an order to adjust a position to a target percent of the</span>
<span class="sd">        current portfolio value. If the position doesn&#39;t already exist, this is</span>
<span class="sd">        equivalent to placing a new order. If the position does exist, this is</span>
<span class="sd">        equivalent to placing an order for the difference between the target</span>
<span class="sd">        percent and the current percent.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        asset : Asset</span>
<span class="sd">            The asset that this order is for.</span>
<span class="sd">        target : float</span>
<span class="sd">            The desired percentage of the portfolio value to allocate to</span>
<span class="sd">            ``asset``. This is specified as a decimal, for example:</span>
<span class="sd">            0.50 means 50%.</span>
<span class="sd">        limit_price : float, optional</span>
<span class="sd">            The limit price for the order.</span>
<span class="sd">        stop_price : float, optional</span>
<span class="sd">            The stop price for the order.</span>
<span class="sd">        style : ExecutionStyle</span>
<span class="sd">            The execution style for the order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        order_id : str</span>
<span class="sd">            The unique identifier for this order.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        ``order_target_value`` does not take into account any open orders. For</span>
<span class="sd">        example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">           order_target_percent(sid(0), 10)</span>
<span class="sd">           order_target_percent(sid(0), 10)</span>

<span class="sd">        This code will result in 20% of the portfolio being allocated to sid(0)</span>
<span class="sd">        because the first call to ``order_target_percent`` will not have been</span>
<span class="sd">        filled when the second ``order_target_percent`` call is made.</span>

<span class="sd">        See :func:`zipline.api.order` for more information about</span>
<span class="sd">        ``limit_price``, ``stop_price``, and ``style``</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :class:`zipline.finance.execution.ExecutionStyle`</span>
<span class="sd">        :func:`zipline.api.order`</span>
<span class="sd">        :func:`zipline.api.order_target`</span>
<span class="sd">        :func:`zipline.api.order_target_value`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_order_asset</span><span class="p">(</span><span class="n">asset</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order_target_percent_amount</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span>
                          <span class="n">limit_price</span><span class="o">=</span><span class="n">limit_price</span><span class="p">,</span>
                          <span class="n">stop_price</span><span class="o">=</span><span class="n">stop_price</span><span class="p">,</span>
                          <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_order_target_percent_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order_percent_amount</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_order_target_amount</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">target_amount</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="nd">@expect_types</span><span class="p">(</span><span class="n">share_counts</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
    <span class="nd">@expect_dtypes</span><span class="p">(</span><span class="n">share_counts</span><span class="o">=</span><span class="n">int64_dtype</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">batch_market_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">share_counts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place a batch market order for multiple assets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        share_counts : pd.Series[Asset -&gt; int]</span>
<span class="sd">            Map from asset to number of shares to order for that asset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        order_ids : pd.Index[str]</span>
<span class="sd">            Index of ids for newly-created orders.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">MarketOrder</span><span class="p">()</span>
        <span class="n">order_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">share_counts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">amount</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">batch_order</span><span class="p">(</span><span class="n">order_args</span><span class="p">)</span>

    <span class="nd">@error_keywords</span><span class="p">(</span><span class="n">sid</span><span class="o">=</span><span class="s1">&#39;Keyword argument `sid` is no longer supported for &#39;</span>
                        <span class="s1">&#39;get_open_orders. Use `asset` instead.&#39;</span><span class="p">)</span>
    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve all of the current open orders.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        asset : Asset</span>
<span class="sd">            If passed and not None, return only the open orders for the given</span>
<span class="sd">            asset instead of all open orders.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        open_orders : dict[list[Order]] or list[Order]</span>
<span class="sd">            If no asset is passed this will return a dict mapping Assets</span>
<span class="sd">            to a list containing all the open orders for the asset.</span>
<span class="sd">            If an asset is passed then this will return a list of the open</span>
<span class="sd">            orders for this asset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">asset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">to_api_obj</span><span class="p">()</span> <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">orders</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">open_orders</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">orders</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">asset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">open_orders</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">open_orders</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">to_api_obj</span><span class="p">()</span> <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">get_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lookup an order based on the order id returned from one of the</span>
<span class="sd">        order functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order_id : str</span>
<span class="sd">            The unique identifier for the order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        order : Order</span>
<span class="sd">            The order object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span><span class="o">.</span><span class="n">to_api_obj</span><span class="p">()</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancel an open order.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order_param : str or Order</span>
<span class="sd">            The order_id or order object to cancel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order_id</span> <span class="o">=</span> <span class="n">order_param</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order_param</span><span class="p">,</span> <span class="n">zipline</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">Order</span><span class="p">):</span>
            <span class="n">order_id</span> <span class="o">=</span> <span class="n">order_param</span><span class="o">.</span><span class="n">id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blotter</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="nd">@require_initialized</span><span class="p">(</span><span class="n">HistoryInInitialize</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar_count</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">ffill</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DEPRECATED: use ``data.history`` instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The `history` method is deprecated.  Use `data.history` instead.&quot;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="n">ZiplineDeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">4</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_history_window</span><span class="p">(</span>
            <span class="n">bar_count</span><span class="p">,</span>
            <span class="n">frequency</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_universe</span><span class="p">(),</span>
            <span class="n">field</span><span class="p">,</span>
            <span class="n">ffill</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_history_window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar_count</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">assets</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">ffill</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_before_trading_start</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span><span class="o">.</span><span class="n">get_history_window</span><span class="p">(</span>
                <span class="n">assets</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
                <span class="n">bar_count</span><span class="p">,</span>
                <span class="n">frequency</span><span class="p">,</span>
                <span class="n">field</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_frequency</span><span class="p">,</span>
                <span class="n">ffill</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If we are in before_trading_start, we need to get the window</span>
            <span class="c1"># as of the previous market minute</span>
            <span class="n">adjusted_dt</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span><span class="o">.</span><span class="n">previous_minute</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span>
                <span class="p">)</span>

            <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span><span class="o">.</span><span class="n">get_history_window</span><span class="p">(</span>
                <span class="n">assets</span><span class="p">,</span>
                <span class="n">adjusted_dt</span><span class="p">,</span>
                <span class="n">bar_count</span><span class="p">,</span>
                <span class="n">frequency</span><span class="p">,</span>
                <span class="n">field</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_frequency</span><span class="p">,</span>
                <span class="n">ffill</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Get the adjustments between the last market minute and the</span>
            <span class="c1"># current before_trading_start dt and apply to the window</span>
            <span class="n">adjs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_portal</span><span class="o">.</span><span class="n">get_adjustments</span><span class="p">(</span>
                <span class="n">assets</span><span class="p">,</span>
                <span class="n">field</span><span class="p">,</span>
                <span class="n">adjusted_dt</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span>
            <span class="p">)</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">window</span> <span class="o">*</span> <span class="n">adjs</span>

            <span class="k">return</span> <span class="n">window</span>

    <span class="c1">####################</span>
    <span class="c1"># Account Controls #</span>
    <span class="c1">####################</span>

    <span class="k">def</span> <span class="nf">register_account_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a new AccountControl to be checked on each bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RegisterAccountControlPostInit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_account_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_controls</span><span class="p">:</span>
            <span class="n">control</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">get_datetime</span><span class="p">(),</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">trading_client</span><span class="o">.</span><span class="n">current_data</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_max_leverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_leverage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a limit on the maximum leverage of the algorithm.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_leverage : float</span>
<span class="sd">            The maximum leverage for the algorithm. If not provided there will</span>
<span class="sd">            be no maximum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">MaxLeverage</span><span class="p">(</span><span class="n">max_leverage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_account_control</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_min_leverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_leverage</span><span class="p">,</span> <span class="n">grace_period</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a limit on the minimum leverage of the algorithm.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        min_leverage : float</span>
<span class="sd">            The minimum leverage for the algorithm.</span>
<span class="sd">        grace_period : pd.Timedelta</span>
<span class="sd">            The offset from the start date used to enforce a minimum leverage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">start_session</span> <span class="o">+</span> <span class="n">grace_period</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">MinLeverage</span><span class="p">(</span><span class="n">min_leverage</span><span class="p">,</span> <span class="n">deadline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_account_control</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>

    <span class="c1">####################</span>
    <span class="c1"># Trading Controls #</span>
    <span class="c1">####################</span>

    <span class="k">def</span> <span class="nf">register_trading_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a new TradingControl to be checked prior to order calls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RegisterTradingControlPostInit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trading_controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_max_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">asset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">max_shares</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">max_notional</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">on_error</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a limit on the number of shares and/or dollar value held for the</span>
<span class="sd">        given sid. Limits are treated as absolute values and are enforced at</span>
<span class="sd">        the time that the algo attempts to place an order for sid. This means</span>
<span class="sd">        that it&#39;s possible to end up with more than the max number of shares</span>
<span class="sd">        due to splits/dividends, and more than the max notional due to price</span>
<span class="sd">        improvement.</span>

<span class="sd">        If an algorithm attempts to place an order that would result in</span>
<span class="sd">        increasing the absolute value of shares/dollar value exceeding one of</span>
<span class="sd">        these limits, raise a TradingControlException.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        asset : Asset, optional</span>
<span class="sd">            If provided, this sets the guard only on positions in the given</span>
<span class="sd">            asset.</span>
<span class="sd">        max_shares : int, optional</span>
<span class="sd">            The maximum number of shares to hold for an asset.</span>
<span class="sd">        max_notional : float, optional</span>
<span class="sd">            The maximum value to hold for an asset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">MaxPositionSize</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span>
                                  <span class="n">max_shares</span><span class="o">=</span><span class="n">max_shares</span><span class="p">,</span>
                                  <span class="n">max_notional</span><span class="o">=</span><span class="n">max_notional</span><span class="p">,</span>
                                  <span class="n">on_error</span><span class="o">=</span><span class="n">on_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_trading_control</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_max_order_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">asset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">max_shares</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">max_notional</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">on_error</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a limit on the number of shares and/or dollar value of any single</span>
<span class="sd">        order placed for sid.  Limits are treated as absolute values and are</span>
<span class="sd">        enforced at the time that the algo attempts to place an order for sid.</span>

<span class="sd">        If an algorithm attempts to place an order that would result in</span>
<span class="sd">        exceeding one of these limits, raise a TradingControlException.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        asset : Asset, optional</span>
<span class="sd">            If provided, this sets the guard only on positions in the given</span>
<span class="sd">            asset.</span>
<span class="sd">        max_shares : int, optional</span>
<span class="sd">            The maximum number of shares that can be ordered at one time.</span>
<span class="sd">        max_notional : float, optional</span>
<span class="sd">            The maximum value that can be ordered at one time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">MaxOrderSize</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span>
                               <span class="n">max_shares</span><span class="o">=</span><span class="n">max_shares</span><span class="p">,</span>
                               <span class="n">max_notional</span><span class="o">=</span><span class="n">max_notional</span><span class="p">,</span>
                               <span class="n">on_error</span><span class="o">=</span><span class="n">on_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_trading_control</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_max_order_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_count</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a limit on the number of orders that can be placed in a single</span>
<span class="sd">        day.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_count : int</span>
<span class="sd">            The maximum number of orders that can be placed on any single day.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">MaxOrderCount</span><span class="p">(</span><span class="n">on_error</span><span class="p">,</span> <span class="n">max_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_trading_control</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_do_not_order_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restricted_list</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a restriction on which assets can be ordered.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        restricted_list : container[Asset], SecurityList</span>
<span class="sd">            The assets that cannot be ordered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">restricted_list</span><span class="p">,</span> <span class="n">SecurityList</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;`set_do_not_order_list(security_lists.leveraged_etf_list)` &quot;</span>
                <span class="s2">&quot;is deprecated. Use `set_asset_restrictions(&quot;</span>
                <span class="s2">&quot;security_lists.restrict_leveraged_etfs)` instead.&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="n">ZiplineDeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">restrictions</span> <span class="o">=</span> <span class="n">SecurityListRestrictions</span><span class="p">(</span><span class="n">restricted_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;`set_do_not_order_list(container_of_assets)` is deprecated. &quot;</span>
                <span class="s2">&quot;Create a zipline.finance.asset_restrictions.&quot;</span>
                <span class="s2">&quot;StaticRestrictions object with a container of assets and use &quot;</span>
                <span class="s2">&quot;`set_asset_restrictions(StaticRestrictions(&quot;</span>
                <span class="s2">&quot;container_of_assets))` instead.&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="n">ZiplineDeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">restrictions</span> <span class="o">=</span> <span class="n">StaticRestrictions</span><span class="p">(</span><span class="n">restricted_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_asset_restrictions</span><span class="p">(</span><span class="n">restrictions</span><span class="p">,</span> <span class="n">on_error</span><span class="p">)</span>

    <span class="nd">@api_method</span>
    <span class="nd">@expect_types</span><span class="p">(</span>
        <span class="n">restrictions</span><span class="o">=</span><span class="n">Restrictions</span><span class="p">,</span>
        <span class="n">on_error</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_asset_restrictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restrictions</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a restriction on which assets can be ordered.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        restricted_list : Restrictions</span>
<span class="sd">            An object providing information about restricted assets.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        zipline.finance.asset_restrictions.Restrictions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">RestrictedListOrder</span><span class="p">(</span><span class="n">on_error</span><span class="p">,</span> <span class="n">restrictions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_trading_control</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restrictions</span> <span class="o">|=</span> <span class="n">restrictions</span>

    <span class="nd">@api_method</span>
    <span class="k">def</span> <span class="nf">set_long_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a rule specifying that this algorithm cannot take short</span>
<span class="sd">        positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_trading_control</span><span class="p">(</span><span class="n">LongOnly</span><span class="p">(</span><span class="n">on_error</span><span class="p">))</span>

    <span class="c1">##############</span>
    <span class="c1"># Pipeline API</span>
    <span class="c1">##############</span>
    <span class="nd">@api_method</span>
    <span class="nd">@require_not_initialized</span><span class="p">(</span><span class="n">AttachPipelineAfterInitialize</span><span class="p">())</span>
    <span class="nd">@expect_types</span><span class="p">(</span>
        <span class="n">pipeline</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">string_types</span><span class="p">,</span>
        <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">attach_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a pipeline to be computed at the start of each day.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pipeline : Pipeline</span>
<span class="sd">            The pipeline to have computed.</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the pipeline.</span>
<span class="sd">        chunks : int or iterator, optional</span>
<span class="sd">            The number of days to compute pipeline results for. Increasing</span>
<span class="sd">            this number will make it longer to get the first results but</span>
<span class="sd">            may improve the total runtime of the simulation. If an iterator</span>
<span class="sd">            is passed, we will run in chunks based on values of the iterator.</span>
<span class="sd">            Default is True.</span>
<span class="sd">        eager : bool, optional</span>
<span class="sd">            Whether or not to compute this pipeline prior to</span>
<span class="sd">            before_trading_start.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pipeline : Pipeline</span>
<span class="sd">            Returns the pipeline that was attached unchanged.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`zipline.api.pipeline_output`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">chunks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Make the first chunk smaller to get more immediate results:</span>
            <span class="c1"># (one week, then every half year)</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="n">chain</span><span class="p">([</span><span class="mi">5</span><span class="p">],</span> <span class="n">repeat</span><span class="p">(</span><span class="mi">126</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipelines</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DuplicatePipelineName</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pipelines</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">AttachedPipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="nb">iter</span><span class="p">(</span><span class="n">chunks</span><span class="p">),</span> <span class="n">eager</span><span class="p">)</span>

        <span class="c1"># Return the pipeline to allow expressions like</span>
        <span class="c1"># p = attach_pipeline(Pipeline(), &#39;name&#39;)</span>
        <span class="k">return</span> <span class="n">pipeline</span>

    <span class="nd">@api_method</span>
    <span class="nd">@require_initialized</span><span class="p">(</span><span class="n">PipelineOutputDuringInitialize</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">pipeline_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get results of the pipeline attached by with name ``name``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the pipeline from which to fetch results.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results : pd.DataFrame</span>
<span class="sd">            DataFrame containing the results of the requested pipeline for</span>
<span class="sd">            the current simulation date.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NoSuchPipeline</span>
<span class="sd">            Raised when no pipeline with the name `name` has been registered.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`zipline.api.attach_pipeline`</span>
<span class="sd">        :meth:`zipline.pipeline.engine.PipelineEngine.run_pipeline`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pipe</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipelines</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoSuchPipeline</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">valid</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pipelines</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_output</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pipeline_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal implementation of `pipeline_output`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">normalize_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_datetime</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">today</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Calculate the next block.</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">valid_until</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_pipeline</span><span class="p">(</span>
                <span class="n">pipeline</span><span class="p">,</span> <span class="n">today</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">chunks</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">valid_until</span><span class="p">)</span>

        <span class="c1"># Now that we have a cached result, try to return the data for today.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">today</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># This happens if no assets passed the pipeline screen on a given</span>
            <span class="c1"># day.</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[],</span> <span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">start_session</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute `pipeline`, providing values for at least `start_date`.</span>

<span class="sd">        Produces a DataFrame containing data for days between `start_date` and</span>
<span class="sd">        `end_date`, where `end_date` is defined by:</span>

<span class="sd">            `end_date = min(start_date + chunksize trading days,</span>
<span class="sd">                            simulation_end)`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (data, valid_until) : tuple (pd.DataFrame, pd.Timestamp)</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        PipelineEngine.run_pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trading_calendar</span><span class="o">.</span><span class="n">all_sessions</span>

        <span class="c1"># Load data starting from the previous trading day...</span>
        <span class="n">start_date_loc</span> <span class="o">=</span> <span class="n">sessions</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">start_session</span><span class="p">)</span>

        <span class="c1"># ...continuing until either the day before the simulation end, or</span>
        <span class="c1"># until chunksize days of data have been loaded.</span>
        <span class="n">sim_end_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">end_session</span>

        <span class="n">end_loc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="n">start_date_loc</span> <span class="o">+</span> <span class="n">chunksize</span><span class="p">,</span>
            <span class="n">sessions</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">sim_end_session</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">end_session</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="n">end_loc</span><span class="p">]</span>

        <span class="k">return</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">run_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">start_session</span><span class="p">,</span> <span class="n">end_session</span><span class="p">),</span> \
            <span class="n">end_session</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_pipeline_domain</span><span class="p">(</span><span class="n">calendar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a default pipeline domain for algorithms running on ``calendar``.</span>

<span class="sd">        This will be used to infer a domain for pipelines that only use generic</span>
<span class="sd">        datasets when running in the context of a TradingAlgorithm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_DEFAULT_DOMAINS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">calendar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">GENERIC</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_fetch_csv_country_code</span><span class="p">(</span><span class="n">calendar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a default country_code to use for fetch_csv symbol lookups.</span>

<span class="sd">        This will be used to disambiguate symbol lookups for fetch_csv calls if</span>
<span class="sd">        our asset db contains entries with the same ticker spread across</span>
<span class="sd">        multiple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_DEFAULT_FETCH_CSV_COUNTRY_CODES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">calendar</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1">##################</span>
    <span class="c1"># End Pipeline API</span>
    <span class="c1">##################</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all_api_methods</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of all the TradingAlgorithm API methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">fn</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;is_api_method&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">]</span>


<span class="c1"># Map from calendar name to default domain for that calendar.</span>
<span class="n">_DEFAULT_DOMAINS</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="o">.</span><span class="n">calendar_name</span><span class="p">:</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">domain</span><span class="o">.</span><span class="n">BUILT_IN_DOMAINS</span><span class="p">}</span>
<span class="c1"># Map from calendar name to default country code for that calendar.</span>
<span class="n">_DEFAULT_FETCH_CSV_COUNTRY_CODES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">d</span><span class="o">.</span><span class="n">calendar_name</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">domain</span><span class="o">.</span><span class="n">BUILT_IN_DOMAINS</span>
<span class="p">}</span>
<span class="c1"># Include us_futures, which doesn&#39;t have a pipeline domain.</span>
<span class="n">_DEFAULT_FETCH_CSV_COUNTRY_CODES</span><span class="p">[</span><span class="s1">&#39;us_futures&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;US&#39;</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Quantopian Inc..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>